#!/usr/bin/env zsh

source "$SHA1N_PROFILE_HOME/scripts/lib.zsh"

# runs mtime based cleanup on the bazel disk-cache directory.
function bazel_with_disk_cache_guard() {
  ("$BAZEL_BIN_PATH" "$@")
  local rc="$?"

  (find "$BAZEL_DISK_CACHE_DIR" -type f -mtime +$BAZEL_DISK_CACHE_MAX_AGE -delete &)
  if [[ "$?" != "0" ]]; then
    __profile_log_warn "[${funcstack[1]}] disk cache cleanup failed"
  fi

  return "$rc"
}

#
# searches the current path for a '.start' file and sources it if found. Otherwise prints an error.
#
function start() {
  local dir="$PWD"
  while [[ ! -f "$dir/.start" ]]
  do 
    if [[ "$(realpath $dir)" == "/" ]]; then 
      break
    fi
    dir="$dir/.."
  done

  if [[ -f "./.start" ]]; then 
    source "$dir/.start"
  else
    __profile_log_error "no '.start' file could be found in the current directory tree"
  fi
}

#
# searches for the nearest jest and executes it in the current directory.
#
function jest() {
  local dir="$PWD"
  while [[ ! -f "$dir/node_modules/jest/bin/jest.js" ]]
  do 
    if [[ "$(realpath $dir)" == "/" ]]; then 
      break
    fi
    dir="$dir/.."
  done

  if [[ -f "$dir/node_modules/jest/bin/jest.js" ]]; then 
    node "$dir/node_modules/jest/bin/jest.js" "$@"
  else
    __profile_log_error "couldn't find jest in the current directory tree"
  fi
}